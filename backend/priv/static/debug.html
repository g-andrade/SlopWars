<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SLOP! Debug</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #0f1117; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }

  header { padding: 12px 20px; background: #1a1d27; border-bottom: 1px solid #2a2d3a; display: flex; align-items: center; gap: 12px; }
  header h1 { font-size: 16px; font-weight: 600; }
  #status { font-size: 12px; padding: 3px 10px; border-radius: 12px; font-weight: 500; }
  #status.connected { background: #0d3320; color: #4ade80; }
  #status.disconnected { background: #3b1219; color: #f87171; }
  #status.connecting { background: #3b2f08; color: #facc15; }
  #game-phase { font-size: 12px; padding: 3px 10px; border-radius: 12px; background: #1e293b; color: #94a3b8; }

  main { flex: 1; display: flex; overflow: hidden; }

  #log-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #log { flex: 1; overflow-y: auto; padding: 12px 20px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; line-height: 1.6; }
  .log-entry { padding: 2px 0; }
  .log-entry.sent { color: #60a5fa; }
  .log-entry.recv { color: #4ade80; }
  .log-entry.error { color: #f87171; }
  .log-entry.system { color: #a78bfa; }
  .log-entry .ts { color: #6b7280; margin-right: 8px; }

  #game-panel { width: 380px; background: #1a1d27; border-left: 1px solid #2a2d3a; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
  .panel-section { background: #0f1117; border: 1px solid #2a2d3a; border-radius: 8px; padding: 14px; }
  .panel-section h3 { font-size: 12px; text-transform: uppercase; color: #6b7280; margin-bottom: 8px; letter-spacing: 0.5px; }
  .stat { display: flex; justify-content: space-between; font-size: 13px; padding: 2px 0; }
  .stat-val { color: #a78bfa; font-weight: 600; }

  footer { padding: 12px 20px; background: #1a1d27; border-top: 1px solid #2a2d3a; }
  #controls { display: flex; gap: 8px; flex-wrap: wrap; }
  input { padding: 10px 14px; background: #0f1117; border: 1px solid #2a2d3a; border-radius: 8px; color: #e0e0e0; font-size: 14px; font-family: inherit; outline: none; flex: 1; min-width: 200px; }
  input:focus { border-color: #6366f1; }
  input:disabled { opacity: 0.5; }
  button { padding: 10px 16px; border-radius: 8px; border: none; font-size: 13px; font-weight: 500; cursor: pointer; transition: background 0.15s; }
  button:disabled { opacity: 0.4; cursor: default; }
  .btn-primary { background: #6366f1; color: white; }
  .btn-primary:hover:not(:disabled) { background: #4f46e5; }
  .btn-action { background: #dc2626; color: white; }
  .btn-action:hover:not(:disabled) { background: #b91c1c; }
  .btn-shield { background: #2563eb; color: white; }
  .btn-shield:hover:not(:disabled) { background: #1d4ed8; }
  .btn-raw { background: #2a2d3a; color: #e0e0e0; }
  .btn-raw:hover { background: #3a3d4a; }
</style>
</head>
<body>

<header>
  <h1>SLOP! Debug</h1>
  <span id="status" class="disconnected">disconnected</span>
  <span id="game-phase">idle</span>
</header>

<main>
  <div id="log-panel">
    <div id="log"></div>
  </div>
  <div id="game-panel">
    <div class="panel-section" id="your-build-panel" style="display:none">
      <h3>Your Build</h3>
      <div id="your-build"></div>
    </div>
    <div class="panel-section" id="opponent-build-panel" style="display:none">
      <h3>Opponent Build</h3>
      <div id="opponent-build"></div>
    </div>
    <div class="panel-section" id="hp-panel" style="display:none">
      <h3>Game State</h3>
      <div id="hp-display"></div>
    </div>
  </div>
</main>

<footer>
  <div id="controls">
    <button id="join-btn" class="btn-primary" disabled>Join Queue</button>
    <input id="prompt" type="text" placeholder="Enter your build prompt..." disabled />
    <button id="submit-btn" class="btn-primary" disabled>Submit Prompt</button>
    <button id="shoot-btn" class="btn-action" disabled>Shoot</button>
    <button id="shield-btn" class="btn-shield" disabled>Spawn Shield</button>
    <input id="tower-hp-input" type="number" placeholder="Tower HP" style="min-width:80px;flex:0" disabled />
    <button id="tower-hp-btn" class="btn-action" disabled>Set Tower HP</button>
    <button id="pos-btn" class="btn-raw" disabled>Send Position</button>
    <button id="raw-btn" class="btn-raw" title="Send raw JSON">Raw</button>
  </div>
</footer>

<script>
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const phaseEl = document.getElementById('game-phase');
const promptEl = document.getElementById('prompt');
const joinBtn = document.getElementById('join-btn');
const submitBtn = document.getElementById('submit-btn');
const shootBtn = document.getElementById('shoot-btn');
const shieldBtn = document.getElementById('shield-btn');
const towerHpInput = document.getElementById('tower-hp-input');
const towerHpBtn = document.getElementById('tower-hp-btn');
const posBtn = document.getElementById('pos-btn');
const rawBtn = document.getElementById('raw-btn');

let ws = null;
let reconnectTimer = null;
let gameState = { phase: 'idle', playerNumber: null, roomId: null, yourBuild: null, opponentBuild: null };

function ts() {
  return new Date().toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function log(text, cls) {
  const div = document.createElement('div');
  div.className = 'log-entry ' + cls;
  div.innerHTML = '<span class="ts">' + ts() + '</span>' + escapeHtml(text);
  logEl.appendChild(div);
  logEl.scrollTop = logEl.scrollHeight;
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function setStatus(state) {
  statusEl.textContent = state;
  statusEl.className = state;
  joinBtn.disabled = state !== 'connected' || gameState.phase !== 'idle';
}

function setPhase(phase) {
  gameState.phase = phase;
  phaseEl.textContent = phase;
  joinBtn.disabled = phase !== 'idle' || !ws || ws.readyState !== WebSocket.OPEN;
  promptEl.disabled = phase !== 'prompting';
  submitBtn.disabled = phase !== 'prompting';
  shootBtn.disabled = phase !== 'playing';
  shieldBtn.disabled = phase !== 'playing';
  towerHpInput.disabled = phase !== 'playing';
  towerHpBtn.disabled = phase !== 'playing';
  posBtn.disabled = phase !== 'playing';
}

function sendMsg(obj) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  const json = JSON.stringify(obj);
  ws.send(json);
  log('\u2192 ' + json, 'sent');
}

function renderBuild(container, build) {
  container.innerHTML = `
    <div class="stat"><span>Tone</span><span class="stat-val">${build.tone}</span></div>
    <div class="stat"><span>Bomb Damage</span><span class="stat-val">${build.bomb_damage}</span></div>
    <div class="stat"><span>Tower HP</span><span class="stat-val">${build.tower_hp}</span></div>
    <div class="stat"><span>Shield HP</span><span class="stat-val">${build.shield_hp}</span></div>
    <div class="stat"><span>Bomb</span><span class="stat-val" style="font-size:11px">${build.bomb_description || '-'}</span></div>
    <div class="stat"><span>Tower</span><span class="stat-val" style="font-size:11px">${build.tower_description || '-'}</span></div>
    <div class="stat"><span>Shield</span><span class="stat-val" style="font-size:11px">${build.shield_description || '-'}</span></div>
  `;
}

function updateHpDisplay(msg) {
  const panel = document.getElementById('hp-panel');
  const display = document.getElementById('hp-display');
  panel.style.display = 'block';
  display.innerHTML = `<div class="stat"><span>Player ${msg.target_player} Tower HP</span><span class="stat-val">${msg.hp}</span></div>`;
}

function handleMessage(msg) {
  switch (msg.type) {
    case 'queued':
      setPhase('queued');
      log('In queue, waiting for opponent...', 'system');
      break;
    case 'matched':
      gameState.roomId = msg.room_id;
      gameState.playerNumber = msg.player_number;
      setPhase('prompting');
      log(`Matched! Room: ${msg.room_id}, You are Player ${msg.player_number}`, 'system');
      promptEl.focus();
      break;
    case 'prompt_received':
      log(`Player ${msg.player} prompt received`, 'system');
      break;
    case 'both_prompts_in':
      log('Both prompts submitted!', 'system');
      break;
    case 'analyzing':
      setPhase('analyzing');
      log('AI Slop Brain analyzing prompts...', 'system');
      break;
    case 'builds_ready':
      gameState.yourBuild = msg.your_build;
      gameState.opponentBuild = msg.opponent_build;
      document.getElementById('your-build-panel').style.display = 'block';
      document.getElementById('opponent-build-panel').style.display = 'block';
      renderBuild(document.getElementById('your-build'), msg.your_build);
      renderBuild(document.getElementById('opponent-build'), msg.opponent_build);
      setPhase('playing');
      log('Builds ready — FIGHT!', 'system');
      break;
    case 'player_update':
      log(`Player ${msg.player} position: ${JSON.stringify(msg.position)}, rotation: ${JSON.stringify(msg.rotation)}`, 'system');
      break;
    case 'shoot':
      log(`Player ${msg.player} shot! ${JSON.stringify(msg)}`, 'system');
      break;
    case 'spawn_shield':
      log(`Player ${msg.player} spawned shield`, 'system');
      break;
    case 'tower_hp':
      updateHpDisplay(msg);
      log(`Player ${msg.player} reports Player ${msg.target_player} tower HP: ${msg.hp}`, 'system');
      break;
    case 'game_over':
      setPhase('game_over');
      log(`GAME OVER! Player ${msg.winner} wins (${msg.reason})`, 'system');
      break;
    case 'opponent_disconnected':
      setPhase('game_over');
      log('Opponent disconnected — you win!', 'system');
      break;
    case 'error':
      log('Error: ' + msg.message, 'error');
      break;
  }
}

function connect() {
  if (ws) { ws.onclose = null; ws.close(); }
  clearTimeout(reconnectTimer);

  const prefix = location.pathname.replace(/\/debug$/, '');
  const url = 'ws://' + location.host + prefix + '/ws';
  log('Connecting to ' + url, 'system');
  setStatus('connecting');

  ws = new WebSocket(url);

  ws.onopen = () => {
    log('Connected', 'system');
    setStatus('connected');
    setPhase('idle');
  };

  ws.onmessage = (e) => {
    log('\u2190 ' + e.data, 'recv');
    try { handleMessage(JSON.parse(e.data)); } catch (_) {}
  };

  ws.onerror = () => log('WebSocket error', 'error');

  ws.onclose = (e) => {
    log('Disconnected (code ' + e.code + ')', 'system');
    setStatus('disconnected');
    setPhase('idle');
    reconnectTimer = setTimeout(connect, 3000);
    log('Reconnecting in 3s...', 'system');
  };
}

joinBtn.addEventListener('click', () => sendMsg({ type: 'join_queue' }));

submitBtn.addEventListener('click', () => {
  const text = promptEl.value.trim();
  if (!text) return;
  sendMsg({ type: 'submit_prompt', prompt: text });
  promptEl.value = '';
  promptEl.disabled = true;
  submitBtn.disabled = true;
});

promptEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submitBtn.click(); }
});

shootBtn.addEventListener('click', () => sendMsg({ type: 'shoot', direction: {x: 0, y: 1, z: 0}, power: 5 }));
shieldBtn.addEventListener('click', () => sendMsg({ type: 'spawn_shield' }));
towerHpBtn.addEventListener('click', () => {
  const hp = parseInt(towerHpInput.value, 10);
  if (!isNaN(hp)) sendMsg({ type: 'tower_hp', hp: hp });
});
posBtn.addEventListener('click', () => sendMsg({ type: 'player_update', position: {x: 1, y: 2, z: 3}, rotation: {x: 0, y: 0, z: 0} }));

rawBtn.addEventListener('click', () => {
  const json = window.prompt('Enter raw JSON to send:');
  if (json) { ws.send(json); log('\u2192 ' + json, 'sent'); }
});

connect();
</script>
</body>
</html>
